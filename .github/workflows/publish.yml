name: Publish

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate tag matches app version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          APP_VERSION="$(/usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' dockr/Info.plist)"
          if [[ "$TAG_VERSION" != "$APP_VERSION" ]]; then
            echo "Tag ${GITHUB_REF_NAME} does not match app version ${APP_VERSION}."
            exit 1
          fi

      - name: Build DOCKR
        env:
          DOCKR_GITHUB_OWNER: ${{ github.repository_owner }}
          DOCKR_GITHUB_REPO: ${{ github.event.repository.name }}
        run: ./scripts/build.sh

      - name: Package release artifacts
        run: |
          ./scripts/package-release.sh
          shasum -a 256 dist/*.zip > dist/DOCKR-${GITHUB_REF_NAME}-SHA256.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/*.zip
            dist/*SHA256.txt
